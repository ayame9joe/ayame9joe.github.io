<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Nick Balestra - JavaScript’s lexical scope, hoisting and closures without mystery</title>
  <link rel="shortcut icon" href="/assets/images/favicon.png">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="alternate" type="application/rss+xml" title="Nick Balestra" href="/feed.xml">
  <link rel="stylesheet" href="/assets/css/highlight.css">
</head>
<body>

  <nav class="main-nav">
    
        <a href='/'> <span class="arrow">←</span> Home </a>
    

    
    <a href='/about'>About </a>
    
    <a class="cta" href="/feed.xml">Subscribe</a>
</nav>

  

  <section id="wrapper" class="">
    <article class="post">
    <header>
        <h1>JavaScript’s lexical scope, hoisting and closures without mystery</h1>
        <h2 class="headline">January 17, 2015</h2>
    </header>
    <section id="post-body">
        <h2>Although javascript falls under the category of ‘dynamic’ or ‘interpreted’ languages it is actually a compiled language. I’m no compiler-guy, so I won’t even try to go deeper into details, but is important to know this to better understand some of the logic governing the language.</h2>

<hr>

<p>So, let me state it again: Javascript is a compiled language. Why this is so important? Well, if you just dig deeper into how a compiler works, you will see how JS scope is defined, leading you to understand not just scope, but also hoisting and closures without the mystery or magic that so often come attached to those topics.</p>

<p>This article is part of a series I’m mainly writing for myself during my learning journey, as I’m steering myself from being a product designer with a passion for code into a software engineer with a passion for design. I picked JS to be my mother tongue for many reasons: some falls under <a href="http://www.2ality.com/2014/07/javascript-survival-guide.html">Axel Rauschmayer’s post</a>.
Treat this post as a summary/note on <a href="https://twitter.com/getify">Kyle Simpson’s</a> <a href="http://shop.oreilly.com/product/0636920026327.do">book on scope &amp; closures</a> and his <a href="https://frontendmasters.com/courses/advanced-javascript/">advanced JS workshop</a>, in that sense this post is not comprehensive and I strongly encourage you to dig both of Kyle original resources as the amount of details he shovels there are worth every second of your time and every penny of your money. My thanks goes to him, for his awesome book on scope and closures and his ability to explain complex concepts easily enough for me to get.</p>

<h2>Scope meets compiler</h2>

<p>So, I mentioned that javascript is a compiled language, but what does this mean? Shortly, just before execution, the source code is sent by the engine trough a compiler, in which, during an early phase called lexing (or tokenizing), scope get defined. This doesn’t just tell us what’s in a name, but also remember us that lexical scope is based on where variables and blocks of scope have been authored in the source code. In other words, lexical scope is defined by you during author time and frozen by the lexer during compilation. Let’s show this with the help of a little example:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="err">‘</span><span class="nx">something</span><span class="err">’</span><span class="p">;</span></code></pre></div>

<p>As the compiler encounter the variable declaration for <em>a</em> (var a) it asks scope to see if the variable a already exists for that particular scope. If so, it just ignore it and move forward, otherwise it asks scope to declare (create) <em>a</em> new variable named <em>a</em> for that scope.</p>

<h2>Engine meets scope</h2>

<p>When engine executes the code that the compiler produced it will see our above example’s code to be something like:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="nx">a</span> <span class="o">=</span> <span class="err">‘</span><span class="nx">something</span><span class="err">’</span><span class="p">;</span></code></pre></div>

<p>Spot the difference? Yes, the var keyword is missing, this is because variables declaration was already handled by compiler, and engine will, therefore, proceed to the assignment. To do so, it will first do a scope LHS (left-hand side) look-up for variable <em>a</em>. As Kyle suggests in his book the conversation between Engine and Scope could sounds like:</p>

<blockquote>
<p><strong>Engine</strong>: Hey Scope, I’ve got an LHS reference for <em>a</em>, ever heard of it?</p>

<p><strong>Scope</strong>: Why yes, I have. Compiler declared it as a variable just recently. Here you go.</p>

<p><strong>Engine</strong>: Helpful as always, Scope. Thanks again. Now, time to assign the string ‘something’ to <em>a</em>.</p>
</blockquote>

<p>At this point, we can all infer what scope is. Scope is where to look for things, or more precisely, scope is where engine will look for things. But what happen in the case of nested scopes? Where will engine look for things? Engine will perform an LHS look-up on the current scope and if he doesn’t find the variable in there it will then perform the LHS look-up on the closest outer scope, and so on, traversing nested scopes until it will get to the outermost scope, the global scope. There his search will terminate. If nothing is found in the global scope two things could happen depending if you are running in strict mode or not:</p>

<ol>
<li>If you are running in ES5 strict mode: engine would throw a ReferenceError as you would logically imagine,</li>
<li>otherwise global scope will just create a variable with that name in the global scope and hand it back to the engine. We can imagine global scope’s reply to sounds like:
<br><br></li>
</ol>

<blockquote>
<p><strong>Global Scope</strong>: No engine, there wasn’t one before, but I was helpful and created one for you. Here it is.</p>
</blockquote>

<p>Think of scopes as strictly nested bubbles, not like Venn diagrams where the bubbles can cross boundaries. As a takeaway, write code in strict mode.</p>

<h2>Function and Block level scope</h2>

<p>What create a scope then? Although not completely true the common wisdom is that javascript has function-based scope only. Meaning that each declared function create its own scope. Let’s take the following example:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">2</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">3</span>     <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno">4</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="lineno">5</span> <span class="p">}</span>
<span class="lineno">6</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="c1">// 1</span>
<span class="lineno">7</span> <span class="nx">foo</span><span class="p">();</span>          <span class="c1">// 10</span></code></pre></div>

<p>Scope of <em>foo</em> is nested inside global scope, hiding what gets defined inside of it from the outer world. In such cases we can also speak of ‘shadowing <em>a</em>’. Scope-based hiding techniques can be useful to build the API for a module/object, where you should expose only what is minimally necessary, and “hide” everything else, following the software design principle called “<a href="http://en.wikipedia.org/wiki/Principle_of_least_privilege">Principle of Least Privilege</a>”, also known as “Least Authority” or “Least Exposure.</p>

<p>What are then the mechanics that create block-level scope? <em>with</em> and <em>try/catch</em> and coming up in ES6 <em>const</em> and <em>let</em>. I’ll give here some more details about the latest one mentioned: <em>let</em>. The <em>let</em> keyword can be used for variable declaration instead of <em>var</em>, and in fact attaches the variable declaration to the scope of whatever block (usually a { .. } pair) it’s contained in. In other words, <em>let</em> implicitly hijacks any block’s scope for its variable declaration.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="kd">let</span> <span class="nx">foo</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno">3</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">foo</span> <span class="p">);</span> <span class="c1">// 10</span>
<span class="lineno">4</span> <span class="p">}</span>
<span class="lineno">5</span> 
<span class="lineno">6</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">foo</span> <span class="p">);</span> <span class="c1">// ReferenceError</span></code></pre></div>

<p><em>let</em> also come packed with a special behavior when used inside a for loop header:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">2</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">i</span> <span class="p">);</span> <span class="c1">// 0 1 2 3 4</span>
<span class="lineno">3</span> <span class="p">}</span>
<span class="lineno">4</span> 
<span class="lineno">5</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">i</span> <span class="p">);</span> <span class="c1">// ReferenceError</span></code></pre></div>

<p>This is very useful not only for avoiding collisions and scope-pollution but also for closures as we’ll see later as <em>let</em> will do its binding on every iteration of the loop.</p>

<h2>Hoisting</h2>

<p>First, let see hoisting in action</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="nx">foo</span><span class="p">();</span> <span class="c1">// ‘hello hoisting’</span>
<span class="lineno">2</span> 
<span class="lineno">3</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">4</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">‘</span><span class="nx">hello</span> <span class="nx">hoisting</span><span class="err">’</span><span class="p">);</span>
<span class="lineno">5</span> <span class="p">}</span></code></pre></div>

<p>As you can see we can invoke <em>foo</em> before it has been declared and the code will run just as if the opposite happened. Well, by now something should start ringing a bell, wasn’t this indeed happening during compilation? Right! During a compilation, every declaration (of variables or function) get added to the relative scope. Function declaration hoisting differs from variables as the content of the function get hoisted too. That’s it. I’ve read so many posts about hosting and many seemed to refer to something more or less mystical, you know, when variables declaration are moved on the top following some unknown reason…</p>

<p>Remember that functions declaration and not function expression are hoisted, and that functions are hoisted first, and then variables:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="nx">foo</span><span class="p">();</span> <span class="c1">// 3</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="kd">var</span> <span class="nx">foo</span><span class="p">;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 6</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
<span class="lineno"> 7</span> <span class="p">}</span>
<span class="lineno"> 8</span> <span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 9</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
<span class="lineno">10</span> <span class="p">};</span>
<span class="lineno">11</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">12</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>
<span class="lineno">13</span> <span class="p">}</span></code></pre></div>

<p>Also, notice how function declaration can override each other (instead, if we were going to declare multiple times var foo nothing will have happened). This should be pretty straightforward as variables declaration just create a variable in a specific scope with their name only while function declaration also bring with them their content.</p>

<p>However, declarations made with let will <em>not</em> hoist to the entire scope of the block they appear in. Such declarations will not observable “exist” in the block until the declaration statement.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno">1</span> <span class="p">{</span>
<span class="lineno">2</span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">foo</span> <span class="p">);</span> <span class="c1">// ReferenceError!</span>
<span class="lineno">3</span>    <span class="kd">let</span> <span class="nx">foo</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="lineno">4</span> <span class="p">}</span></code></pre></div>

<h2>Closures</h2>

<p>In his book Kyle gives a very straightforward definition for what a closure is:</p>

<blockquote>
<p>Closure is when a function is able to remember and access its lexical scope even when that function is executing outside its lexical scope.</p>
</blockquote>

<p>If you think about lexical scope, this is so straight forward, cause scope is defined on author time and set in stone during compilation, therefore it have nothing to do with runtime and the call-stack(different will be if javascript will have been based on dynamic scope, but perhaps I will write a post about <em>‘this’</em> in the near future…). This mean that a function <em>bar</em> defined inside a function <em>foo</em> will have access to the outer scope of <em>foo</em>, also if being returned within it and invoked outside of <em>foo</em>, or in other words, outside of its scope,yes, its lexical scope! If it sounds complex, this latest example will make it clearer.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="lineno"> 1</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">// &#39;scope of foo&#39; aka lexical scope for bar</span>
<span class="lineno"> 2</span>    <span class="kd">var</span> <span class="nx">memory</span> <span class="o">=</span> <span class="s1">&#39;hello closure&#39;</span><span class="p">;</span>
<span class="lineno"> 3</span>    <span class="k">return</span> <span class="kd">function</span> <span class="nx">bar</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 4</span>       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">memory</span><span class="p">);</span>
<span class="lineno"> 5</span>    <span class="p">}</span>
<span class="lineno"> 6</span> <span class="p">}</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="kd">var</span> <span class="nx">memory</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
<span class="lineno"> 9</span>     <span class="nx">baz</span> <span class="o">=</span> <span class="nx">foo</span><span class="p">();</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="nx">baz</span><span class="p">();</span> <span class="c1">// &#39;hello closure&#39;</span></code></pre></div>

<p>Thanks to <a href="https://twitter.com/bojanpopic">Bojan</a>, <a href="https://twitter.com/stipsan">Stian</a> and <a href="https://twitter.com/ryanvannin">Ryan</a> for reviews and feedbacks.</p>

<p>If you have any question, comment or feedback, please get in touch on <a href="http://twitter.com/nickbalestra">twitter</a> or drop me a line at nick at balestra dot ch.</p>

    </section>
</article>
<footer id="post-meta" class="clearfix">
    <a href="http://twitter.com/nickbalestra">
        <img class="avatar" src="/assets/images/profile.png">
        <div>
            <span class="dark">Nick Balestra</span>
            <span>Software engineer</span>
        </div>
    </a>

    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=http://nick.balestra.ch/2015/javascripts-lexical-scope-hoisting-and-closures-without-mystery/ - JavaScript’s lexical scope, hoisting and closures without mystery by @nickbalestra"><span class="icon-twitter"> Tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>
    </section>
</footer>

<!-- Disqus comments -->

    <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'nickbalestra';
        var disqus_developer = 0; // developer mode is on
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


<!-- Archive -->

    <ul id="post-list" class="archive readmore">
        <h3>Read more</h3>
        
            <li>
                <a href="/2015/ES6-classes-and-prototype-based-inheritance/">JS's Prototype-based inheritance and classes demystified<aside class="dates">Oct 15</aside></a>
            </li>
        
            <li>
                <a href="/2015/depthFirst-vs-breadthFirst/">DepthFirst and breadthFirst tree walking<aside class="dates">Oct 10</aside></a>
            </li>
        
            <li>
                <a href="/2015/ES6-Arrows-Arrays-and-Defaults/">中文测试<aside class="dates">Oct 05</aside></a>
            </li>
        
            <li>
                <a href="/2015/Installing-Ruby-Gems-Without-Sudo/">Install ruby gems without sudo on OSX<aside class="dates">Oct 04</aside></a>
            </li>
        
            <li>
                <a href="/2015/Installing-Node-Global/">Installing npm packages global on OSX<aside class="dates">Oct 04</aside></a>
            </li>
        
            <li>
                <a href="/2015/pick-your-parsing/">Pick your parsing<aside class="dates">Sep 05</aside></a>
            </li>
        
            <li>
                <a href="/2015/sweetjs-case-macros-for-javascript/">Case based Macros for javaScript<aside class="dates">Aug 29</aside></a>
            </li>
        
            <li>
                <a href="/2015/hrb-sicp-studygroup/">HRB SICP Study group - Getting started with Lisp<aside class="dates">Aug 23</aside></a>
            </li>
        
            <li>
                <a href="/2015/for-loops-the-bad-the-good-the-ugly/">For* Loops: The Bad, The Good And The Ugly<aside class="dates">Aug 08</aside></a>
            </li>
        
            <li>
                <a href="/2015/build-a-simple-api-server-with-node/">Building a simple API server with node<aside class="dates">Jul 26</aside></a>
            </li>
        
            <li>
                <a href="/2015/Backbone-bindings-for-firebase/">Binding Backbone models & collections to Firebase<aside class="dates">Jul 24</aside></a>
            </li>
        
            <li>
                <a href="/2015/classes-and-instantiation-patterns-in-javascript/">Classes and Instantiation Patterns in javaScript<aside class="dates">Jul 05</aside></a>
            </li>
        
            <li>
                <a href="/2015/Prefix-tree-data-structure/">Prefix Tree Data Structure<aside class="dates">Jul 05</aside></a>
            </li>
        
            <li>
                <a href="/2015/javascript-functional-libraries/">JS Functional Programming Libraries<aside class="dates">Jun 13</aside></a>
            </li>
        
            <li>
                <a href="/2015/Kactus/">Kactus for Jekyll<aside class="dates">Jun 11</aside></a>
            </li>
        
            <li>
                <a href="/2015/IIFE/">The IIFE pattern<aside class="dates">Jun 08</aside></a>
            </li>
        
            <li>
                <a href="/2015/truthy-and-falsy/">Truthy and falsy values<aside class="dates">Jun 07</aside></a>
            </li>
        
            <li>
                <a href="/2015/prime-algos/">Trial division, Sieve of Eratosthenes and Factorization Wheel<aside class="dates">May 25</aside></a>
            </li>
        
            <li>
                <a href="/2015/using-every-to-return-some/">Using every() to return some()<aside class="dates">May 15</aside></a>
            </li>
        
            <li>
                <a href="/2015/jekyll-on-github-quick-guide/">Jekyll on Github - Quick guide<aside class="dates">May 10</aside></a>
            </li>
        
            <li>
                <a href="/2015/hackbot-a-js-robot-for-the-browser/">Hackbot - A js robot for the browser<aside class="dates">Jan 26</aside></a>
            </li>
        
            <li>
                <a href="/2015/intro-js-onboarding-api/">Intro.js onboarding API<aside class="dates">Jan 25</aside></a>
            </li>
        
            <li>
                <a href="/2015/javascripts-lexical-scope-hoisting-and-closures-without-mystery/">JavaScript’s lexical scope, hoisting and closures without mystery<aside class="dates">Jan 17</aside></a>
            </li>
        
    </ul>





  </section>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/assets/js/main.js"></script>


  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-62842593-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
